# SIMMHT â€” Simulation of Magnetic Hyperthermia in Tumors (2D Bioheat)



**SIMMHT** is a numerical solver for **magnetic nanoparticle-induced hyperthermia** in biological tissue, based on the **Pennes bioheat equation** with an **internal magnetic heat source** driven by nanoparticle relaxation losses. The code targets **parametric studies** and **dataset generation** for inverse problems, optimization, and machine learning (ML) applications in hyperthermia planning.

---

## âœï¸ Governing Equation

The solver advances the Pennes bioheat equation in 2D:
$$
\rho c \frac{\partial T}{\partial t}
= \nabla \cdot (k \nabla T)
+ \omega \rho_b c_b (T_b - T)
+ Q_{\text{ext}}
+ Q_{\text{mag}}(t,T)
$$

- **Perfusion** follows a temperature-dependent law (distinct for tumor and healthy tissue).
- **Magnetic source** $Q_{\text{mag}}$ comes from the imaginary part of the dynamic susceptibility, $\chi''$, computed by an internal routine (`imag`) using an RK4 integration of the relaxation model.

---

## ğŸ“ File / Module Structure

```
.
â”œâ”€â”€ simmht.f90         # Program driver (batch runs / time loop / file I/O wiring)
â”œâ”€â”€ variables.f90      # Global parameters, arrays, and physical properties
â”œâ”€â”€ input.f90          # Reads domain, material properties and general simulation settings (config.dat)
â”œâ”€â”€ functions.f90      # Numerical kernels and post-processing:
â”‚   â”œâ”€ mesh()                          # grid generation
â”‚   â”œâ”€ id_vector()                     # tumor mask (circular)
â”‚   â”œâ”€ perfusao_sanguinea()            # nonlinear blood perfusion
â”‚   â”œâ”€ solucao_explicita()             # explicit time stepping of Pennes
â”‚   â”œâ”€ aplicar_contornos_explicito()   # zero-flux (Neumann) boundaries
â”‚   â”œâ”€ imag()                          # Ï‡â€³ computation (RK4 + relaxation physics)
â”‚   â”œâ”€ compute_metrics()               # tumor stats, SAR, affected radius/area
â”‚   â””â”€ main()                          # multi-run controller; writes outputs.dat
â”œâ”€â”€ makefile            # Build instructions
â”œâ”€â”€ config.dat          # Global inputs (domain, tissue props, sim time, etc.)
â”œâ”€â”€ inputs.dat          # Sweep inputs per simulation: PHI, H, omega, particle_radius
â””â”€â”€ outputs.dat         # (generated) per-simulation metrics for downstream analysis
```

### Key Routines (inside `functions.f90`)

| Routine | Purpose |
|---|---|
| `mesh()` | Build structured Cartesian grid. |
| `id_vector()` | Tag tumor vs healthy tissue (circular mask). |
| `perfusao_sanguinea()` | Update perfusion `W(T)` per-node (different laws per region). |
| `solucao_explicita()` | Explicit (forward Euler) time-advance of the bioheat equation. |
| `aplicar_contornos_explicito()` | Zero-flux Neumann boundary conditions. |
| `imag()` | Compute \(\chi''\) for magnetic source via RK4 relaxation model. |
| `compute_metrics()` | Post-processing: min/max/avg/std temperature in tumor, mean SAR (W/kg), affected radius/area in healthy tissue. |
| `main()` | Multi-run logic: reads sweep, advances in time, writes `outputs.dat`. |

---

## ğŸ”§ Build

### Using the provided makefile (recommended)

```bash
make
```

### Directly with `gfortran`

```bash
gfortran -O3 -fopenmp -march=native -funroll-loops   -o simmht variables.f90 input.f90 functions.f90 simmht.f90
```

> Dependencies: `gfortran` (Fortran 2008+), a POSIX-like shell for the makefile. OpenMP is optional (can be disabled by removing `-fopenmp`).

---

## â–¶ï¸ Running

SIMMHT supports **sweep mode**: each simulation in the batch uses a set of parameters that can be automatically generated by a single execution. Typical workflow:

1. Configure the **domain and tissue properties** in `config.dat`.
2. Compile using make;  
4. Run the solver:
   ```bash
   ./simmht
   ```
5. Inspect the generated **dataset** in `outputs.dat`.

### Output: `outputs.dat` columns

The solver automatically writes outputs.dat, containing per-simulation metrics:
```
"SIMULATION","PHI","H","W","PARTICLE_RADIUS","TC","S_TIME","TMIN","TAVG","TSTD","SAR","R_AFET"

```

- **TC**: steady-state temperature at tumor center (or snapshot value if early stop criterion is met).
- **S_TIME**: time to steady-state (or time at early stop).
- **TMIN/TAVG/TSTD**: spatial statistics across tumor nodes.
- **SAR**: magnetic source converted to W/kg (mean value in tumor under homogeneous conditions).
- **R_AFET**: affected radius in healthy tissue where $T > T_\mathrm{ini} + 1^{\circ}\mathrm{C}$.

---

## ğŸ“Š Intended Use

- Parametric and sensitivity analysis of magnetic hyperthermia.
- Dataset generation for **Machine Learning** (surrogates, inverse problems, optimization).
- Rapid evaluation of **therapeutic metrics**: intratumoral heating vs healthy-tissue exposure.
- Baseline for further model upgrades (implicit schemes, anisotropy, spatially varying properties).

---

## ğŸ› ï¸ Roadmap (Next Steps)

âœ… explicit solver with metrics export

ğŸ”„ robust implicit scheme (Crankâ€“Nicolson, line-by-line)

ğŸ“Œ multi-tumor/multi-region support

ğŸ”¥ temperature-dependent tissue conductivity

ğŸ“ VTK output for post-processing in Paraview

ğŸ§  automated dataset generation for ML experiments

---

## References

If you use SIMMHT or its datasets in academic works, please cite:

- **Gontijo, R.G.; Ossege, F.E.L.; Pereira, J.L.J.** *Evaluation of machine learning algorithms in the prediction of key therapeutic quantities in magnetic hyperthermia.* **Computers & Mathematics with Applications**, 194:362â€“378, 2025.  [![DOI](https://img.shields.io/badge/DOI-10.1016%2Fj.camwa.2025.06.026-blue)](https://doi.org/10.1016/j.camwa.2025.06.026)

You may also acknowledge the SIMMHT repository and version used in your study.
